name: Auto-Backport Hotfix to Integration

# Workflow automatique pour backporter les hotfixes des branches release vers integration
# Se dÃ©clenche automatiquement quand une PR est mergÃ©e sur une branche release/*

on:
  pull_request:
    types: [closed]
    branches:
      - 'release/**'

jobs:
  backport:
    name: Backport to Integration
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create backport branch
        id: create-backport
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          TARGET_BRANCH="integration"
          BACKPORT_BRANCH="backport/pr-${PR_NUMBER}-to-integration"

          echo "ðŸ”„ Creating backport of PR #${PR_NUMBER} to ${TARGET_BRANCH}"
          echo "Source: ${SOURCE_BRANCH}"
          echo "Title: ${PR_TITLE}"

          git fetch origin ${TARGET_BRANCH}
          git checkout ${TARGET_BRANCH}

          git checkout -b ${BACKPORT_BRANCH}

          echo "backport_branch=${BACKPORT_BRANCH}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "pr_title=${PR_TITLE}" >> $GITHUB_OUTPUT

      - name: Cherry-pick commits
        id: cherry-pick
        continue-on-error: true
        run: |
          MERGE_COMMIT=${{ github.event.pull_request.merge_commit_sha }}

          echo "Cherry-picking commit: ${MERGE_COMMIT}"

          if git cherry-pick ${MERGE_COMMIT}; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Cherry-pick successful"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Cherry-pick failed - conflicts detected"
          fi

      - name: Push backport branch
        if: steps.cherry-pick.outputs.success == 'true'
        run: |
          BACKPORT_BRANCH="${{ steps.create-backport.outputs.backport_branch }}"

          git push origin ${BACKPORT_BRANCH}

          echo "âœ… Backport branch pushed: ${BACKPORT_BRANCH}"

      - name: Create Pull Request
        if: steps.cherry-pick.outputs.success == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ steps.create-backport.outputs.pr_number }}
          PR_TITLE="${{ steps.create-backport.outputs.pr_title }}"
          BACKPORT_BRANCH="${{ steps.create-backport.outputs.backport_branch }}"

          echo "## Automatic Backport" > /tmp/pr_body.md
          echo "" >> /tmp/pr_body.md
          echo "This PR backports the changes from #${PR_NUMBER} to integration." >> /tmp/pr_body.md
          echo "" >> /tmp/pr_body.md
          echo "### Original PR" >> /tmp/pr_body.md
          echo "- **Title:** ${PR_TITLE}" >> /tmp/pr_body.md
          echo "- **Number:** #${PR_NUMBER}" >> /tmp/pr_body.md
          echo "- **Branch:** ${{ github.event.pull_request.head.ref }}" >> /tmp/pr_body.md
          echo "" >> /tmp/pr_body.md
          echo "### Why this backport?" >> /tmp/pr_body.md
          echo "Hotfixes applied to release branches must be backported to integration to ensure:" >> /tmp/pr_body.md
          echo "- Integration org stays up-to-date" >> /tmp/pr_body.md
          echo "- Future releases include this fix" >> /tmp/pr_body.md
          echo "- No code is lost" >> /tmp/pr_body.md
          echo "" >> /tmp/pr_body.md
          echo "### Review" >> /tmp/pr_body.md
          echo "Please review and merge to complete the backport process." >> /tmp/pr_body.md

          gh pr create \
            --base integration \
            --head ${BACKPORT_BRANCH} \
            --title "[Backport] ${PR_TITLE} (from #${PR_NUMBER})" \
            --body-file /tmp/pr_body.md \
            --label "backport" \
            --label "hotfix"

          echo "âœ… Pull Request created for backport"

      - name: Comment on conflicts
        if: steps.cherry-pick.outputs.success == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ steps.create-backport.outputs.pr_number }}

          echo "## Automatic Backport Failed" > /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "The automatic backport of this PR to integration failed due to conflicts." >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "### Manual action required:" >> /tmp/comment.md
          echo "1. Checkout integration branch" >> /tmp/comment.md
          echo "2. Create a new branch: backport/pr-${PR_NUMBER}-to-integration" >> /tmp/comment.md
          echo "3. Manually cherry-pick or apply the changes from this PR" >> /tmp/comment.md
          echo "4. Resolve conflicts" >> /tmp/comment.md
          echo "5. Create a PR to integration" >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "### Commands:" >> /tmp/comment.md
          echo '```bash' >> /tmp/comment.md
          echo "git checkout integration" >> /tmp/comment.md
          echo "git pull" >> /tmp/comment.md
          echo "git checkout -b backport/pr-${PR_NUMBER}-to-integration" >> /tmp/comment.md
          echo "git cherry-pick ${{ github.event.pull_request.merge_commit_sha }}" >> /tmp/comment.md
          echo "# Resolve conflicts if any" >> /tmp/comment.md
          echo "git push origin backport/pr-${PR_NUMBER}-to-integration" >> /tmp/comment.md
          echo '```' >> /tmp/comment.md

          gh pr comment ${PR_NUMBER} --body-file /tmp/comment.md

          echo "âš ï¸  Conflict comment posted on PR #${PR_NUMBER}"

      - name: Summary
        run: |
          echo "## ðŸ”„ Backport Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Original PR:** #${{ steps.create-backport.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ steps.create-backport.outputs.pr_title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** integration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.cherry-pick.outputs.success }}" == "true" ]]; then
            echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A backport PR has been automatically created." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Failed (conflicts)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Manual backport required. See comment on original PR." >> $GITHUB_STEP_SUMMARY
          fi
