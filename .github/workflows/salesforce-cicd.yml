name: Salesforce CI/CD Pipeline

on:
  push:
    branches:
      - integration
      - uat
      - main
  pull_request:
    branches:
      - integration
      - uat
      - main

env:
  SFDX_CLI_VERSION: latest

jobs:
  # Job 1: Validation et tests
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest
    environment: ${{ (github.event_name == 'pull_request' && github.base_ref || github.ref_name) == 'main' && 'PRODUCTION' || (github.event_name == 'pull_request' && github.base_ref || github.ref_name) == 'uat' && 'UAT' || 'INTEGRATION' }}
    outputs:
      env_name: ${{ steps.env.outputs.ENV_NAME }}
      job_id: ${{ steps.validate.outputs.job_id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli@${SFDX_CLI_VERSION}
          sf --version

      - name: Determine target environment
        id: env
        run: |
          echo "üîç Debug: github.ref = ${{ github.ref }}"
          echo "üîç Debug: github.ref_name = ${{ github.ref_name }}"
          echo "üîç Debug: github.event_name = ${{ github.event_name }}"
          echo "üîç Debug: github.base_ref = ${{ github.base_ref }}"

          # Pour les Pull Requests, utiliser la branche de base (cible)
          # Pour les push, utiliser la branche actuelle
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH="${{ github.base_ref }}"
            echo "üîç Pull Request detected, using base branch: $BRANCH"
          else
            BRANCH="${{ github.ref_name }}"
            echo "üîç Push detected, using current branch: $BRANCH"
          fi

          if [[ "$BRANCH" == "main" ]]; then
            echo "ENV_NAME=PRODUCTION" >> $GITHUB_OUTPUT
            echo "ORG_ALIAS=production" >> $GITHUB_OUTPUT
            echo "‚úÖ Environment detected: PRODUCTION"
          elif [[ "$BRANCH" == "uat" ]]; then
            echo "ENV_NAME=UAT" >> $GITHUB_OUTPUT
            echo "ORG_ALIAS=uat" >> $GITHUB_OUTPUT
            echo "‚úÖ Environment detected: UAT"
          elif [[ "$BRANCH" == "integration" ]]; then
            echo "ENV_NAME=INTEGRATION" >> $GITHUB_OUTPUT
            echo "ORG_ALIAS=integration" >> $GITHUB_OUTPUT
            echo "‚úÖ Environment detected: INTEGRATION"
          else
            echo "‚ùå Error: Branch $BRANCH is not configured for CI/CD"
            echo "Only integration, uat, and main branches trigger deployments"
            exit 1
          fi

          echo "üîç Debug: ENV_NAME and ORG_ALIAS set in GITHUB_OUTPUT"

      - name: Authenticate to Salesforce
        env:
          SF_CONSUMER_KEY: ${{ secrets[format('SF_CONSUMER_KEY_{0}', steps.env.outputs.ENV_NAME)] }}
          SF_USERNAME: ${{ secrets[format('SF_USERNAME_{0}', steps.env.outputs.ENV_NAME)] }}
          SF_PRIVATE_KEY: ${{ secrets[format('SF_PRIVATE_KEY_{0}', steps.env.outputs.ENV_NAME)] }}
        run: |
          if [ -z "${SF_CONSUMER_KEY}" ] || [ -z "${SF_USERNAME}" ] || [ -z "${SF_PRIVATE_KEY}" ]; then
            echo "‚ùå Error: JWT secrets not configured for ${{ steps.env.outputs.ENV_NAME }}"
            echo "Please configure these secrets in GitHub Settings > Environments > ${{ steps.env.outputs.ENV_NAME }}:"
            echo "  - SF_CONSUMER_KEY_${{ steps.env.outputs.ENV_NAME }}"
            echo "  - SF_USERNAME_${{ steps.env.outputs.ENV_NAME }}"
            echo "  - SF_PRIVATE_KEY_${{ steps.env.outputs.ENV_NAME }}"
            exit 1
          fi

          echo "${SF_PRIVATE_KEY}" > server.key

          sf org login jwt \
            --client-id "${SF_CONSUMER_KEY}" \
            --jwt-key-file server.key \
            --username "${SF_USERNAME}" \
            --alias ${{ steps.env.outputs.ORG_ALIAS }} \
            --instance-url https://login.salesforce.com

          rm server.key

      - name: Run Apex Tests
        id: apex-tests
        run: |
          sf apex run test --target-org ${{ steps.env.outputs.ORG_ALIAS }} \
            --test-level RunLocalTests \
            --code-coverage \
            --result-format human \
            --wait 20 \
            --output-dir ./test-results
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apex-test-results-${{ steps.env.outputs.ENV_NAME }}
          path: ./test-results

      - name: Check test results
        if: steps.apex-tests.outcome == 'failure'
        run: |
          echo "‚ùå Apex tests failed. Deployment cannot proceed."
          exit 1

      - name: Validate deployment (check-only)
        id: validate
        run: |
          RESULT=$(sf project deploy start \
            --target-org ${{ steps.env.outputs.ORG_ALIAS }} \
            --manifest manifest/package.xml \
            --test-level RunLocalTests \
            --dry-run \
            --wait 30 \
            --verbose \
            --json)

          echo "$RESULT"
          JOB_ID=$(echo "$RESULT" | jq -r '.result.id')
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Validation Job ID: $JOB_ID"

      - name: Validation Summary
        run: |
          echo "‚úÖ Validation successful for ${{ steps.env.outputs.ENV_NAME }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Job ID for Quick Deploy: ${{ steps.validate.outputs.job_id }}"

  # Job 2: D√©ploiement avec validation manuelle
  deploy:
    name: Deploy
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    environment:
      name: ${{ needs.validate.outputs.env_name }}
    
    outputs:
      env_name: ${{ steps.env.outputs.ENV_NAME }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli@${SFDX_CLI_VERSION}
          sf --version

      - name: Determine target environment
        id: env
        run: |
          echo "üîç Debug: github.ref = ${{ github.ref }}"
          echo "üîç Debug: github.ref_name = ${{ github.ref_name }}"
          echo "üîç Debug: github.event_name = ${{ github.event_name }}"
          echo "üîç Debug: github.base_ref = ${{ github.base_ref }}"

          # Pour les Pull Requests, utiliser la branche de base (cible)
          # Pour les push, utiliser la branche actuelle
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH="${{ github.base_ref }}"
            echo "üîç Pull Request detected, using base branch: $BRANCH"
          else
            BRANCH="${{ github.ref_name }}"
            echo "üîç Push detected, using current branch: $BRANCH"
          fi

          if [[ "$BRANCH" == "main" ]]; then
            echo "ENV_NAME=PRODUCTION" >> $GITHUB_OUTPUT
            echo "ORG_ALIAS=production" >> $GITHUB_OUTPUT
            echo "‚úÖ Environment detected: PRODUCTION"
          elif [[ "$BRANCH" == "uat" ]]; then
            echo "ENV_NAME=UAT" >> $GITHUB_OUTPUT
            echo "ORG_ALIAS=uat" >> $GITHUB_OUTPUT
            echo "‚úÖ Environment detected: UAT"
          elif [[ "$BRANCH" == "integration" ]]; then
            echo "ENV_NAME=INTEGRATION" >> $GITHUB_OUTPUT
            echo "ORG_ALIAS=integration" >> $GITHUB_OUTPUT
            echo "‚úÖ Environment detected: INTEGRATION"
          else
            echo "‚ùå Error: Branch $BRANCH is not configured for CI/CD"
            echo "Only integration, uat, and main branches trigger deployments"
            exit 1
          fi

          echo "üîç Debug: ENV_NAME and ORG_ALIAS set in GITHUB_OUTPUT"

      - name: Authenticate to Salesforce
        env:
          SF_CONSUMER_KEY: ${{ secrets[format('SF_CONSUMER_KEY_{0}', steps.env.outputs.ENV_NAME)] }}
          SF_USERNAME: ${{ secrets[format('SF_USERNAME_{0}', steps.env.outputs.ENV_NAME)] }}
          SF_PRIVATE_KEY: ${{ secrets[format('SF_PRIVATE_KEY_{0}', steps.env.outputs.ENV_NAME)] }}
        run: |
          if [ -z "${SF_CONSUMER_KEY}" ] || [ -z "${SF_USERNAME}" ] || [ -z "${SF_PRIVATE_KEY}" ]; then
            echo "‚ùå Error: JWT secrets not configured for ${{ steps.env.outputs.ENV_NAME }}"
            echo "Please configure these secrets in GitHub Settings > Environments > ${{ steps.env.outputs.ENV_NAME }}:"
            echo "  - SF_CONSUMER_KEY_${{ steps.env.outputs.ENV_NAME }}"
            echo "  - SF_USERNAME_${{ steps.env.outputs.ENV_NAME }}"
            echo "  - SF_PRIVATE_KEY_${{ steps.env.outputs.ENV_NAME }}"
            exit 1
          fi

          echo "${SF_PRIVATE_KEY}" > server.key

          sf org login jwt \
            --client-id "${SF_CONSUMER_KEY}" \
            --jwt-key-file server.key \
            --username "${SF_USERNAME}" \
            --alias ${{ steps.env.outputs.ORG_ALIAS }} \
            --instance-url https://login.salesforce.com

          rm server.key

      - name: Quick Deploy to Salesforce
        id: deploy
        run: |
          echo "üöÄ Starting Quick Deploy using validation Job ID: ${{ needs.validate.outputs.job_id }}"

          sf project deploy quick \
            --job-id ${{ needs.validate.outputs.job_id }} \
            --target-org ${{ steps.env.outputs.ORG_ALIAS }} \
            --wait 30 \
            --verbose

      - name: Deployment Summary
        if: success()
        run: |
          echo "üöÄ Quick Deploy successful to ${{ steps.env.outputs.ENV_NAME }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Validation Job ID: ${{ needs.validate.outputs.job_id }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed to ${{ steps.env.outputs.ENV_NAME }}"
          exit 1

  # Job 3: Post-deployment verification
  verify:
    name: Post-Deployment Verification
    needs: deploy
    runs-on: ubuntu-latest
    if: success()
    environment: ${{ needs.deploy.outputs.env_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli@${SFDX_CLI_VERSION}

      - name: Determine target environment
        id: env
        run: |
          echo "üîç Debug: github.ref = ${{ github.ref }}"
          echo "üîç Debug: github.ref_name = ${{ github.ref_name }}"
          echo "üîç Debug: github.event_name = ${{ github.event_name }}"
          echo "üîç Debug: github.base_ref = ${{ github.base_ref }}"

          # Pour les Pull Requests, utiliser la branche de base (cible)
          # Pour les push, utiliser la branche actuelle
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH="${{ github.base_ref }}"
            echo "üîç Pull Request detected, using base branch: $BRANCH"
          else
            BRANCH="${{ github.ref_name }}"
            echo "üîç Push detected, using current branch: $BRANCH"
          fi

          if [[ "$BRANCH" == "main" ]]; then
            echo "ENV_NAME=PRODUCTION" >> $GITHUB_OUTPUT
            echo "ORG_ALIAS=production" >> $GITHUB_OUTPUT
            echo "‚úÖ Environment detected: PRODUCTION"
          elif [[ "$BRANCH" == "uat" ]]; then
            echo "ENV_NAME=UAT" >> $GITHUB_OUTPUT
            echo "ORG_ALIAS=uat" >> $GITHUB_OUTPUT
            echo "‚úÖ Environment detected: UAT"
          elif [[ "$BRANCH" == "integration" ]]; then
            echo "ENV_NAME=INTEGRATION" >> $GITHUB_OUTPUT
            echo "ORG_ALIAS=integration" >> $GITHUB_OUTPUT
            echo "‚úÖ Environment detected: INTEGRATION"
          else
            echo "‚ùå Error: Branch $BRANCH is not configured for CI/CD"
            echo "Only integration, uat, and main branches trigger deployments"
            exit 1
          fi

          echo "üîç Debug: ENV_NAME and ORG_ALIAS set in GITHUB_OUTPUT"

      - name: Authenticate to Salesforce
        env:
          SF_CONSUMER_KEY: ${{ secrets[format('SF_CONSUMER_KEY_{0}', steps.env.outputs.ENV_NAME)] }}
          SF_USERNAME: ${{ secrets[format('SF_USERNAME_{0}', steps.env.outputs.ENV_NAME)] }}
          SF_PRIVATE_KEY: ${{ secrets[format('SF_PRIVATE_KEY_{0}', steps.env.outputs.ENV_NAME)] }}
        run: |
          if [ -z "${SF_CONSUMER_KEY}" ] || [ -z "${SF_USERNAME}" ] || [ -z "${SF_PRIVATE_KEY}" ]; then
            echo "‚ùå Error: JWT secrets not configured for ${{ steps.env.outputs.ENV_NAME }}"
            echo "Please configure these secrets in GitHub Settings > Environments > ${{ steps.env.outputs.ENV_NAME }}:"
            echo "  - SF_CONSUMER_KEY_${{ steps.env.outputs.ENV_NAME }}"
            echo "  - SF_USERNAME_${{ steps.env.outputs.ENV_NAME }}"
            echo "  - SF_PRIVATE_KEY_${{ steps.env.outputs.ENV_NAME }}"
            exit 1
          fi

          echo "${SF_PRIVATE_KEY}" > server.key

          sf org login jwt \
            --client-id "${SF_CONSUMER_KEY}" \
            --jwt-key-file server.key \
            --username "${SF_USERNAME}" \
            --alias ${{ steps.env.outputs.ORG_ALIAS }} \
            --instance-url https://login.salesforce.com

          rm server.key

      - name: Run smoke tests
        run: |
          echo "Running post-deployment smoke tests..."
          sf apex run test --target-org ${{ steps.env.outputs.ORG_ALIAS }} \
            --tests "SmokeTestClass" \
            --result-format human \
            --wait 10 || echo "‚ö†Ô∏è  No smoke tests found"

      - name: Verification Complete
        run: |
          echo "‚úÖ Post-deployment verification complete for ${{ steps.env.outputs.ENV_NAME }}"
